name: Arduino Library CI

on:
  
  push:
    branches: [ master, develop, feature/ci ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

jobs:
  
  build:
    name: Build âš™ï¸ğŸ”§
    runs-on: ubuntu-latest
    steps:

      - name: ğŸ“¥ğŸ“„ Clone current Library Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: false
      
      - name: ğŸ”§ğŸ¤– Arduino CI Build
        uses: Arduino-CI/action@v0.1.1
  
  deploy:
    name: Deploy âš™ï¸ğŸš€
    runs-on: ubuntu-latest
    needs: [ build ]
    if: github.event_name == 'push'        
    steps:
      
      - name: ğŸ“¥ğŸ“„ Clone current Library Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  
          persist-credentials: false
      
      - name: ğŸ” Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch
      
      - name: ğŸ’¬ Display branch name
        run: echo 'The current branch name is ' ${{ steps.extract_branch.outputs.branch }}
      
      - name: ğŸ”§ğŸ“œ Doxigen Build
        uses: mattnotmitt/doxygen-action@v1
          
      - name: ğŸ“¥ğŸŒ Clone current gh-pages barnch of the Library Repository
        uses: actions/checkout@v2
        with:
          ref: 'gh-pages'
          path: './.gh-pages'
          clean: true
          fetch-depth: 0   
          persist-credentials: false

      - name: âš™ï¸ğŸ”€ Running a little script to move files
        run: |
          rm -rf ./.gh-pages/docs/${{ steps.extract_branch.outputs.branch }}
          mkdir -p ./.gh-pages/docs/${{ steps.extract_branch.outputs.branch }}
          cp -r ./.doxygen/* ./.gh-pages/docs/${{ steps.extract_branch.outputs.branch }}

      - name: ğŸš€ğŸ“œ Deploy Documentation 
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages
          FOLDER: ./.gh-pages
          CLEAN: true
